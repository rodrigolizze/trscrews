<%# =======================
    SEO meta for product page
    Place this block at the very top of app/views/screws/show.html.erb
    It sets <title>, <meta description> and OG/Twitter image via MetaHelper.
    ======================= %>
<%# // Build a human + keyword-friendly title %>
<% meta_title [
     @screw.description.presence,
     (@screw.thread.presence && "(#{@screw.thread})"),
     [@screw.automaker, @screw.model].compact_blank.join(" ")
   ].compact_blank.join(" — ")
%>

<%# // Short meta description (~150–160 chars is ideal).
    // We stitch a sentence from key attributes and truncate just in case. %>
<% meta_description truncate(
     [
       @screw.description,
       @screw.surface_treatment.presence && "Tratamento: #{@screw.surface_treatment}",
       @screw.thread.presence && "Rosca: #{@screw.thread}",
       [@screw.automaker, @screw.model].compact_blank.presence && "Compatível: #{@screw.automaker} #{@screw.model}"
     ].compact_blank.join(". ") + ".",
     length: 160
   )
%>

<%# // Use first image for social previews if available %>
<% if @screw.images.attached? %>
  <% meta_image url_for(@screw.images.first.variant(resize_to_limit: [800, 800])) %>
<% end %>

<div class="container py-4" data-controller="gallery">
  <div class="mb-3">
    <%= link_to "← Voltar ao catálogo", screws_path, class: "text-decoration-none" %>
  </div>

  <div class="row gx-2 gy-4 align-items-start">
    <%# // Left column: vertical thumbnails (desktop) %>
    <div class="col-12 col-md-auto order-2 order-md-1 d-none d-md-flex flex-column gap-2">
      <% if @screw.images.attached? %>
        <% @screw.images.each do |img| %>
          <a href="#"
             class="d-inline-block"
             data-action="click->gallery#swap"
             data-gallery-target="thumb"
             data-url="<%= url_for(cdn_variant(img, resize_to_limit: [1000, 1000])) %>">
            <%= image_tag cdn_variant(img, resize_to_limit: [200, 200]),
              class: "rounded border opacity-75",
              style: "width: 72px; height: 72px; object-fit: cover;",
              alt: @screw.description,
              loading: "lazy",
              decoding: "async" %>
          </a>
        <% end %>
      <% end %>
    </div>

    <%# // Right column: main image + details %>
    <div class="col-12 col-md order-1 order-md-2">
      <div class="row gx-2 gy-4 align-items-start">
        <div class="col-md-7">
          <%# // pick the newest attached image; nil if none %>
          <% primary = primary_attachment(@screw) %>

          <% if primary %>
            <%= image_tag primary.variant(resize_to_limit: [1000, 1000]),
                  data: { gallery_target: "main" },
                  class: "img-fluid rounded shadow-sm w-100",
                  style: "max-height: 460px; object-fit: contain; background: #fff;",
                  alt: @screw.description %>
          <% else %>
            <div class="bg-light d-flex align-items-center justify-content-center rounded"
                style="height: 360px;">
              <span class="text-muted">Sem imagens</span>
            </div>
          <% end %>
        </div>

          <%# // Mobile thumbnails below the main image %>
          <div class="d-md-none mt-3 d-flex gap-2 overflow-auto">
            <% if @screw.images.attached? %>
              <% @screw.images.each do |img| %>
                <a href="#"
                   class="d-inline-block"
                   data-action="click->gallery#swap"
                   data-gallery-target="thumb"
                   data-url="<%= url_for(img.variant(resize_to_limit: [1000, 1000])) %>">
                  <%= image_tag img.variant(resize_to_limit: [200, 200]),
                                class: "rounded border opacity-75",
                                style: "width: 72px; height: 72px; object-fit: cover;",
                                alt: @screw.description,
                                loading: "lazy",
                                decoding: "async" %>
                </a>
              <% end %>
            <% end %>
          </div>
        </div>

        <div class="col-md-5">
          <small class="text-muted"><%= @screw.thread %> — <%= @screw.surface_treatment %></small>
          <h3 class="fw-bold mt-1"><%= @screw.description %></h3>
          <p class="mb-1 text-muted"><%= @screw.automaker %> - <%= @screw.model %></p>

          <hr>

          <%# // Specs list (only render non-blank fields) %>
          <dl class="row small">
            <% {
              "Rosca" => @screw.thread,
              "Comprimento da rosca" => @screw.thread_length,
              "Classe de resistência" => @screw.resistance_class,
              "Tratamento" => @screw.surface_treatment,
              "Montadora" => @screw.automaker,
              "Modelo" => @screw.model
            }.each do |label, value| %>
              <% next if value.blank? %>
              <dt class="col-6 text-muted"><%= label %></dt>
              <dd class="col-6"><%= value %></dd>
            <% end %>
          </dl>

          <%# // Price + add-to-cart (qty=1) — uses your current route helper add_cart_path %>
          <div class="p-3 bg-light rounded d-flex align-items-center justify-content-between my-3">
            <div>
              <div class="fs-4 fw-bold"><%= format_price(@screw.price) %></div>
                <% if @screw.out_of_stock? %>
                  <span class="badge bg-secondary">Indisponível</span>
                <% else %>
                  <small class="text-muted">Estoque: <%= @screw.stock %> un.</small>
                <% end %>
              </div>

              <% if @screw.in_stock? %>
                <%= button_to "COMPRAR",
                              add_cart_path(screw_id: @screw.id),
                              method: :post,
                              params: { quantity: 1 },
                              class: "btn btn-yellow px-4" %>
              <% else %>
                <button class="btn btn-secondary px-4" disabled>Sem estoque</button>
              <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
